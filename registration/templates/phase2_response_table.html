{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SPAC 2025 | Registration Dashboard</title>
    <link rel="icon" href="{% static '/img/logo.gif' %}" />

    <!-- Tailwind & DaisyUI -->
    <script src="https://cdn.tailwindcss.com/3.4.17"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@5" rel="stylesheet" />

    <!-- Particles -->

    <style>
      tbody tr {
        transition: all 0.2s ease-in-out;
        cursor: pointer;
        text-align: center;
      }
      tbody tr:hover {
        background-color: #00285517;
      }
      .logout {
        background: #c22d2d85;
        color: white;
        padding: 8px 16px;
        border-radius: 6px;
        border: 2px solid #c22d2d;
      }
      .logout:hover {
        background: #c22d2d;
        transition: 0.3s;
      }
      .statistics {
        background: #e49e3581;
        color: white;
        padding: 8px 16px;
        border-radius: 6px;
        border: 2px solid #e49e35;
      }
      .statistics:hover {
        background: #e49e35;
        transition: 0.3s;
      }
      input::placeholder {
        color: #ffffff;
      }
      input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
      }
    </style>
  </head>

  <body class="min-h-screen bg-[#002855]">
    <div class="relative w-11/12 max-w-7xl mx-auto py-10 z-10">
      <!-- Header -->
      <div class="relative mb-20">
        <div class="relative flex justify-center">
          <span
            class="px-10 py-3 text-[#fff] bg-[#002855] border-2 border-white text-xl md:text-3xl rounded-xl shadow-[2px_4px_0_0_#fff] text-center"
          >
            Phase 02 Response Table
          </span>
        </div>
      </div>

      <!-- New row for additional buttons -->
      <div class="flex items-center gap-4 justify-between mb-12">
        <a href="{% url 'core:logout' %}" class="logout">Logout</a>
        <!-- Statistics Button -->
          {% if has_perm.view_finance_info %}
            <button class="statistics" onclick="document.getElementById('statsModal').showModal()">
              Statistics
            </button>
          {% endif %}
      </div>
      
      <!-- Controls -->
      <div class="flex justify-between items-start max-md:flex-col-reverse flex-wrap max-md:gap-5 mb-5">
        <input
          id="tableSearch"
          type="text"
            placeholder="Search by name or email"
            class="px-4 py-2 w-full max-md:mr-3 md:w-1/2 rounded-lg shadow-sm border-2 focus:border-[#ffffffab] focus:outline-none text-white"
          />
          <button
          id="saveBtn"
            class="px-5 py-2 max-md:w-full max-md:mr-3 bg-[#1b395c] text-white rounded-lg shadow hover:bg-[#00629B] border-2 transition-all duration-300 ease-in-out"
            >
            Save Selections
          </button>        
      </div>

      <!-- Table -->
      <div class="bg-white rounded-xl shadow-lg overflow-x-auto max-h-[450px]">
        <table class="min-w-full text-sm">
          <thead class="sticky top-0 z-10">
            <tr class="bg-[#1b395c] text-white">
              <th class="px-4 py-3">ID</th>
              <th class="px-4 py-3">Name</th>
              <th class="px-4 py-3">University</th>
              <th class="px-4 py-3">T-Shirt</th>
              <th class="px-4 py-3">Transaction</th>
              <th class="px-4 py-3">Payment Confirmed?</th>
            </tr>
          </thead>
          <tbody>
            {% for p in participants %}
            <tr
            class="border-b"
            data-href="{% url 'registration:view_response2' p.id %}"
            >
            <td class="px-4 py-3">{{ p.id }}</td>
            <td class="px-4 py-3">{{ p.name }}</td>
            <td class="px-4 py-3">{{ p.institution }}</td>
            <td class="px-4 py-3">{{ p.tshirt_size }}</td>
            <th class="px-4 py-3">{{ p.transaction_id }}</th>
            <td class="px-4 py-3">
              <input
                type="checkbox"
                class="phase2Check"
                data-id="{{p.id}}"
                {% if p.is_payment_confirmed %}checked{% endif %}
              />
            </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="6" class="text-center py-6 text-gray-500">
                No participants found
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Footer -->
      <div class="text-center mt-6 text-gray-200 text-sm italic">
        2025 © IEEE NSU Student Branch
      </div>
    </div>

    {% if has_perm.view_finance_info %}
        <!-- Modal -->
      <dialog id="statsModal" class="modal">
        <div class="modal-box max-w-3xl">
          <h2 class="text-2xl font-bold mb-4">Statistics</h2>

          <div class="overflow-x-auto">
          <table class="table table-zebra w-full border">
            <thead class="bg-gray-700 text-white">
              <tr class="text-center">
                <th class="py-2 px-4 rounded-tl-lg">Membership Grade</th>
                <th class="py-2 px-4">Count</th>
                <th class="py-2 px-4">Amount</th>
                <th class="py-2 px-4 rounded-tr-lg">Total</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="py-2 px-4">IEEE Student Member</td>
                <td class="py-2 px-4">{{registration_stats.student|default:0}}</td>
                <td class="py-2 px-4">810</td>
                <td class="py-2 px-4">{{registration_stats.student_amount_total}}</td>
              </tr>
              <tr>
                <td class="py-2 px-4">IEEE Member</td>
                <td class="py-2 px-4">{{registration_stats.professional|default:0}}</td>
                <td class="py-2 px-4">860</td>
                <td class="py-2 px-4">{{registration_stats.professional_amount_total}}</td>
              </tr>
              <tr>
                <td class="py-2 px-4">Non-IEEE Member</td>
                <td class="py-2 px-4">{{registration_stats.non_ieee|default:0}}</td>
                <td class="py-2 px-4">910</td>
                <td class="py-2 px-4">{{registration_stats.non_ieee_amount_total}}</td>
              </tr>
            </tbody>
          </table>
        </div>
          
          <!-- Total -->
          <div class="mt-4 text-left font-bold text-lg">
            <p style="font-size:smaller;">
            Total Amount: <span class="text-green-600">{{total_amount}}</span>
            </p>
            <p style="font-size:smaller;">
            Total Registrations: <span class="text-green-600">{{reg_stats.total_registrations}}</span>
            </p>
            <p style="font-size:smaller;">
            Payment Confirmed: <span class="text-green-600">{{reg_stats.total_payment_confirmed}}</span>
            </p>
            <br>
            <p style="font-weight: normal;">University List :</p>
            <ul>
              {% for uni in university_data  %}
              <li class="flex items-center px-4 py-2 my-2 text-sm 
                        text-gray-800 bg-gray-100 rounded-md shadow-sm hover:bg-gray-200">
                  <span class="font-medium">{{ uni.institution_sanitized }}</span>
                  <span class="ml-2 text-gray-500">–</span>
                  <span class="ml-2 text-gray-700 font-bold">[{{ uni.total }}]</span>
              </li>
              {% endfor %}
            </ul>
            <br>
            <p style="font-weight: normal;">T-Shirt List :</p>
            <ul>
              {% for tshirt in tshirt_size_data  %}
              <li class="flex items-center px-4 py-2 my-2 text-sm 
                        text-gray-800 bg-gray-100 rounded-md shadow-sm hover:bg-gray-200">
                  <span class="font-medium">{{ tshirt.tshirt_size }}</span>
                  <span class="ml-2 text-gray-500">–</span>
                  <span class="ml-2 text-gray-700 font-bold">[{{ tshirt.count }}]</span>
              </li>
              {% endfor %}
            </ul>
          </div>
          
          <!-- Actions -->
          <div class="modal-action">
            <form method="dialog">
              <button class="btn close">Close</button>
            </form>
          </div>
      </dialog>
      {% endif %}
    </div>

    <!-- Scripts -->
    <script>
      document
        .getElementById("tableSearch")
        .addEventListener("input", function () {
          const q = this.value.toLowerCase();
          document.querySelectorAll("tbody tr").forEach((row) => {
            const name = row.children[1]?.innerText.toLowerCase() || "";
            const email = row.children[3]?.innerText.toLowerCase() || "";
            const uni = row.children[2]?.innerText.toLowerCase() || "";
            const shirt = row.children[4]?.innerText.toLowerCase() || "";
            row.style.display =
              name.includes(q) || email.includes(q) || uni.includes(q) || shirt.includes(q) ? "" : "none";
          });
        });

      // Add Save button listener here
      document.getElementById("saveBtn").addEventListener("click", () => {
        const selected = [
          ...document.querySelectorAll(".phase2Check:checked:not(:disabled)"),
        ].map((cb) => cb.dataset.id);

        // if (!selected.length) {
        //   alert("No participants selected to save");
        //   return;
        // }

        fetch("{% url 'registration:save_selected_phase02' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": '{{csrf_token}}',  // Add CSRF if needed
          },
          body: JSON.stringify({ selected_ids: selected }),
        })
        .then(response => response.json())
        .then(data => {
          alert("Selections saved successfully!");
          window.location.reload();
        })
        .catch(error => {
          console.error("Error saving selections:", error);
          alert("Failed to save selections.");
        });
      });

      // Row click
      document.querySelectorAll("tbody tr").forEach((row) => {
        row.addEventListener("click", (e) => {
          if (e.target.type !== "checkbox") {
            const link = row.dataset.href;
            if (link) window.location.href = link;
          }
        });
      });
    </script>
  </body>
</html>
