{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SPAC 2025 | Registration Form</title>
    <link rel="icon" href="{% static '/img/logo.gif' %}" />
    <!--daisy ui-->
    <link
      href="https://cdn.jsdelivr.net/npm/daisyui@5"
      rel="stylesheet"
      type="text/css"
    />
    <!--tailwind-->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <!-- sweet alert  -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!--particles.js-->
    <script src="{% static 'js/particles.min.js' %}"></script>
    <!-- stats.js lib -->
    <script src="http://threejs.org/examples/js/libs/stats.min.js"></script>

    <style>
      @import url('https://fonts.googleapis.com/css2?family=Instrument+Sans:ital,wght@0,400..700;1,400..700&display=swap');

      body {
        background: transparent;
        background-repeat: no-repeat;
        background-size: cover;
        position: relative;
        z-index: 0;
        font-family: "Instrument Sans", sans-serif;
      }
      .response_count {
        font-size: larger;
        border-bottom: 2px solid #19508e;
        border-top: 1px solid #19508e;
        border-left: 8px solid #19508e;
        border-right: 1px solid #19508e;
        padding: 4px 8px;
        border-radius: 4px;
        background: #c6e8ff;
        color: #122812;
      }
      /* Width of the scrollbar */
      .custom-scrollbar::-webkit-scrollbar {
        width: 5px;
        height: 12px;
      }

      /* Track (background) */
      .custom-scrollbar::-webkit-scrollbar-track {
        background: #a32d2d;
        border-radius: 8px;
      }

      /* Handle (the draggable part) */
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #e53232;
        border-radius: 9999px;
        cursor: pointer;
      }

      /* Handle on hover */
      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #00629B;
      }
      /* particles container */
      canvas {
        display: block;
        vertical-align: bottom;
      }
      #particles-js {
        position: absolute;
        width: 100%;
        height: 100%;
        background-color: #00629B;
        background-image: url("");
        background-repeat: no-repeat;
        background-size: 20%;
        background-position: 50% 50%;
      }
      .count-particles {
        background: #000022;
        position: absolute;
        top: 48px;
        left: 0;
        width: 80px;
        color: #13e8e9;
        font-size: 0.8em;
        text-align: left;
        text-indent: 4px;
        line-height: 14px;
        padding-bottom: 2px;
        font-family: Helvetica, Arial, sans-serif;
        font-weight: bold;
      }
      .js-count-particles {
        font-size: 1.1em;
      }
      #stats,
      .count-particles {
        -webkit-user-select: none;
        margin-top: 5px;
        margin-left: 5px;
      }
      #stats {
        border-radius: 3px 3px 0 0;
        overflow: hidden;
      }
      .count-particles {
        border-radius: 0 0 3px 3px;
      }
      .input_label{
        display: block;
        font-size: 18px;
        margin-bottom: 0.35rem;
        color: #122812;
      }
      .input{
        width: 100%;
        padding: .5rem .75rem;
        border: 1px solid gray;
        border-radius: 0.375rem;
        outline-style: none;
        transition: all .3s ease-in-out;
        background: transparent;
      }
      .input:focus{
        border: 1px solid #00629B;
        box-shadow: 2px 2px 2px #bfdff5;
      }
      .continue-btn{
        color: white;
        background: #00629B;
        padding: 0.5rem 1.25rem;
        border-radius: 0.375rem;
        cursor: pointer;
        border: 1px solid #00629B;
      }
      .continue-btn:hover{
        background: #d3e4f7;
        color: #00629B;
        transition: 0.3s all ease-in-out;
      }
      .admin-btn{
        color: #122812;
        border: 1px solid #122812;
        border-radius: 0.325rem;
        background: #00629B;
        padding: 0.25rem 0.85rem;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        font-size: 1.25rem;
        transition: all 0.3s ease-in-out;
        justify-content: center;
        color: white;
      }
      .admin-btn:hover{
        background: #d3e4f7;
        color: #00629B;
      }
      .back-btn{
        color: #122812;
        border-radius: 1rem;
        cursor: pointer;
        font-size: 1.25rem;
        margin-top: .75rem;
      }
      .section_heading{
        text-align: center;
        font-size: 1.5rem;
        margin-bottom: .5rem;
        margin-bottom: 22px;
      }
      .payment-info-text {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 15px;
        color: #122812;
      }
      .payment-info-text strong {
        color: #00629B;
      }
      @media screen and (max-width: 500px) {
        .response_count {
          margin: 0 auto;
        }
        .admin-btn{
          width: 100%;
          font-size: 1rem;
        }
        .response_count{
          margin: 12px auto;
        }
        .payment-info-text {
          font-size: 1rem;
        }
        .payment-info-text strong {
          font-size: 1.1rem;
        }
      }
    </style>
  </head>

  <body class="py-2 custom-scrollbar min-h-screen">
    <!--Particles JS-->
    <div id="particles-js" class="fixed inset-0 -z-10"></div>

    <div class="w-11/12 md:w-3/5 mx-auto my-4">
      <div class="rounded overflow-hidden shadow-[0px_0px_10px_#00629B] border-1 border-white flex justify-center">
        <img
          src="{% static '/img/SpacBanner.png' %}"
          alt=""
          class="object-cover md:h-auto"
        />
      </div>
    </div>
    {% if has_perm.reg_form_control %}
    <!-- admin feature part  -->
    <div class="rounded">
      <div
        class="bg-[#d3e4f7] w-11/12 md:w-3/5 mx-auto px-6 py-5"
        style="
          backdrop-filter: blur(7px);
          border-radius: 4px 4px;
          box-shadow: 0 2px 6px 0px #00000078;
          position: relative;
          top: 14px;"
      >
        <div
          class="flex flex-col sm:flex-row sm:flex-wrap items-center md:justify-between items-start"
        >
          <div>
            <!-- Publish Form Toggle Button (staff only) -->
            <button
              id="publishToggle"
              type="button"
              class="inline-flex gap-2 px-0 py-2.5 rounded-md font-medium text-lg"
            >
              <input
                id="publishCheckbox"
                type="checkbox"
                {% if is_published %} checked="checked"
                {% endif %}
                class="toggle border-gray-300 bg-gray-400 checked:border-[#00629B] checked:bg-[#D7F5BF] checked:text-[#00629B]"
              />
              {% if is_published %}
              <span
                class="text-xl"
                style="color: #00629B"
                id="publishText"
                >Form published!</span
              >
              {% else %}
              <span
                class="text-xl"
                style="color: rgb(207, 25, 18)"
                id="publishText"
                >Publish Form?</span
              >
              {% endif %}
            </button>
          </div>
          <p class="response_count">
            Response Count:
            <span style="font-weight: bold">{{registration_count}}</span>
          </p>
        </div>
        <div
          class="flex flex-col sm:flex-row gap-3 items-center justify-center sm:justify-center w-full sm:w-auto my-3"
        >
          <!-- Download Excel Button (staff only) -->
          <a
            href="{% url 'registration:download_excel' %}"
            class="admin-btn"
          >
            <svg class="w-4 h-4 fill-current" viewBox="0 0 24 24">
              <path
                d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"
              />
            </svg>
            <span>Download Excel Sheet</span>
          </a>

          {% if has_perm.view_qr_dashboard %}
          <a
            href="{% url 'core:dashboard' %}"
            class="admin-btn"
          >
            <span>Dashboard</span>
          </a>
          {% endif %} 
          {% if has_perm.view_reg_responses_list %}
          <!-- See Responses Button (staff only) -->
          <a
            href="{% url 'registration:response_table' %}"
            class="admin-btn"
          >
            <svg class="w-4 h-4 fill-current" viewBox="0 0 24 24">
              <path
                d="M19,3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3M19,19H5V5H19V19M17,17H7V15H17V17M17,13H7V11H17V13M17,9H7V7H17V9Z"
              />
            </svg>
            <span>See Responses</span>
          </a>
          {% endif %}
        </div>
        {% endif %}
      </div>

      <div
        class="bg-[#d3e4f7] w-11/12 md:w-3/5 mx-auto"
        style="
          backdrop-filter: blur(7px);
          border-radius: 4px 4px;
          box-shadow: 0 2px 6px 0px #00000078;
        "
      >
        {% if not is_staff_view and not is_published and not registration_closed%}
        <div class="shadow-md p-5 font-medium rounded-md">
            <h2 class="text-3xl text-center mb-5 font-mono">
              Phase 01 - Participants Registration -  Student Professional Awareness Conference (SPAC) 2025
            </h2>
            <p class="text-justify">
              We are thrilled to announce the opening of Phase 1 of Registration for one of the most anticipated events of the year - Student Professional Awareness Conference (SPAC) 2024! Phase 1 is your opportunity to secure your spots expressing your interest in joining and being a part of the dynamic experience. 
              <br>
              <br>
              </p>
              <p >
              <b>What's in for Phase 1?</b>
              </p>
              <br>
              Phase 1 is an application selection process based on the answers provided during registration. 
              <br>
              <br>
            </p>
              <ul class="list-disc ml-5">
                <li>Register with your detailed information and enthusiasm to reserve your place</li>
                <li>Gain early access to event updates and details as the phase is on a first come first service</li>
              </ul>
              <br>
              <p class="text-justify">
              Participants selected after reviewing the response from Phase 1 will only be able to register the 2nd phase which will be the payment stage that completes their registration process. So make sure you write everything in detail and mention the required information on the questionnaire section of the Registration form.
              <br>
              <br>
              So Secure your seat by registering soon!!
              <br>
              <br>
              <b>Registration Deadline: 16th December, 2025</b>
              <br>
              <br>
              <b>Event Name</b>: SPAC 2025
              <br>
              <b>Event Date</b>: 29th December 2025
              <br>
              <b>Venue</b>: North South University, Dhaka
              <br>
              <b>Event Type</b>: Day-long flagship program
            </p>
          </div>
        <div
          class="p-6 bg-yellow-50 border border-yellow-300 rounded text-yellow-900 text-center" style="
          margin-top:18px"
        >
          <p>
            Registration is closed as we have reached the maximum number of
            participants.
          </p>
          <p>
            For any queries, contact - <a href="tel:+8801712902722" style="color:#0b5ed7;text-decoration:none;">+880 17 1290 2722</a>
          </p>
        </div>
        {% elif not is_staff_view and registration_closed %}
        <div
          class="p-6 bg-red-50 border border-red-300 rounded text-red-900 text-center"
        >
          Registration is closed as we have reached the maximum number of
          participants.
        </div>
        {% else %}

        <!-- Form wrapper -->
        <form id="registrationForm" method="post" action="/submit-form/">
          {% csrf_token %}

          <!-- Step 1: Basic Info -->
          <section id="step1" class="shadow-md p-5 font-medium rounded-md">
            <h2 class="text-3xl text-center mb-5 font-mono">
              Phase 01 - Participants Registration -  Student Professional Awareness Conference (SPAC) 2025
            </h2>
            <p class="text-justify">
              We are thrilled to announce the opening of Phase 1 of Registration for one of the most anticipated events of the year - Student Professional Awareness Conference (SPAC) 2024! Phase 1 is your opportunity to secure your spots expressing your interest in joining and being a part of the dynamic experience. 
              <br>
              <br>
              </p>
              <p >
              <b>What's in for Phase 1?</b>
              </p>
              <br>
              Phase 1 is an application selection process based on the answers provided during registration. 
              <br>
              <br>
            </p>
              <ul class="list-disc ml-5">
                <li>Register with your detailed information and enthusiasm to reserve your place</li>
                <li>Gain early access to event updates and details as the phase is on a first come first service</li>
              </ul>
              <br>
              <p class="text-justify">
              Participants selected after reviewing the response from Phase 1 will only be able to register the 2nd phase which will be the payment stage that completes their registration process. So make sure you write everything in detail and mention the required information on the questionnaire section of the Registration form.
              <br>
              <br>
              So Secure your seat by registering soon!!
              <br>
              <br>
              <b>Registration Deadline: 16th December, 2025</b>
              <br>
              <br>
              <b>Event Name</b>: SPAC 2025
              <br>
              <b>Event Date</b>: 29th December 2025
              <br>
              <b>Venue</b>: North South University, Dhaka
              <br>
              <b>Event Type</b>: Day-long flagship program
            </p>
            <hr class="my-6 w-[100%] m-auto text-gray-400">
            <h2 class="section_heading">BASIC INFO</h2>
            <!-- name  -->
            <div class="mb-5">
              <label for="name" class="input_label">
                Name<span
                  class="text-red-700 ml-1"
                  >*</span
                >
              </label>
              <input
                type="text"
                name="name"
                id="name"
                placeholder="Enter your Name"
                class="input"
                required
              />
            </div>
            <!-- email  -->
            <div class="mb-5">
              <label for="email" class="input_label">
                Email Address<span class="text-red-700 ml-1">*</span>
              </label>
              <input
                type="email"
                name="email"
                id="email"
                placeholder="Enter your Email"
                class="input"
                required
              />
            </div>
            <!-- contact number -->
            <div class="mb-5">
              <label for="contact_number" class="input_label">
                Contact Number<span class="text-red-700 ml-1">*</span>
              </label>
              <input
                type="number"
                name="contact_number"
                id="contact_number"
                placeholder="Enter your Contact Number"
                class="input"
                required
              />
            </div>

            <!-- university name  -->
            <div class="mb-5">
              <label class="input_label block mb-2">
                Institution Name
                <span class="text-red-700 ml-1">*</span>
              </label>

              <ul class="list-disc pl-6 space-y-4">
                <li>Ahsanullah University of Science and Technology</li>
                <li>American International University Bangladesh</li>
                <li>Bangabandhu Sheikh Mujibur Rahman Science and Technology University, Gopalganj</li>
                <li>Bangladesh University Engineering and Technology</li>
                <li>Bangladesh University of Professionals (BUP)</li>
                <li>BRAC University</li>
                <li>Daffodil International University</li>
                <li>East Delta University</li>
                <li>East West University</li>
                <li>Green University of Bangladesh</li>
                <li>Independent University, Bangladesh</li>
                <li>Jashore University of Science and Technology</li>
                <li>Leading University</li>
                <li>North South University</li>
                <li>Southeast University</li>
                <li>Stamford University Bangladesh</li>
                <li>United International University</li>
                <li>University of Asia Pacific</li>
                <li>Xiamen University Malaysia</li>
                <li>Northern University of Bangladesh, Khulna</li>
              </ul>
            </div>

            <!-- selected phase 1  -->
            <div class="mb-5">
              <label class="input_label block mb-2">
                Are You Selected in Phase 01 on SPAC 2025?
                <span class="text-red-700 ml-1">*</span>
              </label>

              <div class="flex items-center gap-6 mt-2">
                <!-- Yes Option -->
                <label class="flex items-center gap-2 cursor-pointer">
                  <input
                    type="radio"
                    name="selected_phase1"
                    value="yes"
                    required
                    class="radio-input"
                  />
                  <span>Yes</span>
                </label>

                <!-- No Option -->
                <label class="flex items-center gap-2 cursor-pointer">
                  <input
                    type="radio"
                    name="selected_phase1"
                    value="no"
                    required
                    class="radio-input"
                  />
                  <span>No</span>
                </label>
              </div>
            </div>

            <!-- membership Sections -->
            <div class="mb-5">
              <label class="input_label block mb-2">
                Select Your Membership Grade
                <span class="text-red-700 ml-1">*</span>
              </label>

              <div class="flex flex-col gap-3 mt-3">
                <label class="flex items-center gap-2 cursor-pointer">
                  <input
                    type="radio"
                    name="membership_grade"
                    value="student"
                    class="radio-input"
                    required
                  />
                  <span>IEEE Student Member (Undergraduate Students, Grade Students Membership)</span>
                </label>

                <label class="flex items-center gap-2 cursor-pointer">
                  <input
                    type="radio"
                    name="membership_grade"
                    value="professional"
                    class="radio-input"
                  />
                  <span>IEEE Member (Senior Members, Professionals, Faculty Members, Fellow)</span>
                </label>

                <label class="flex items-center gap-2 cursor-pointer">
                  <input
                    type="radio"
                    name="membership_grade"
                    value="non_ieee"
                    class="radio-input"
                  />
                  <span>Non-IEEE Member</span>
                </label>
              </div>
            </div>

            <!--ieee member  -->
            <div id="student_section" class="hidden mt-3 mb-4">
              <label class="input_label block mb-2">IEEE Student Membership ID  <span class="text-red-700 ml-1">*</span></label>
              <input
                type="text"
                name="student_membership_id"
                id="student_membership_id"
                class="input"
                placeholder="Enter your IEEE Student Membership ID"
              />
            </div>

            <!-- senior member  -->
            <div id="professional_section" class="hidden mt-3 mb-4">
              <label class="input_label block mb-2">IEEE Membership ID  <span class="text-red-700 ml-1">*</span></label>
              <input
                type="text"
                name="professional_membership_id"
                id="professional_membership_id"
                class="input"
                placeholder="Enter your IEEE Membership ID"
              />
            </div>

            <div class="flex justify-center">
              <button
                onclick="nextStep()"
                class="continue-btn"
                type="button"
              >
                Continue
              </button>
            </div>
          </section>

          <!-- Step 2: Payment -->
          <section
            id="step2"
            class="hidden shadow-md p-5 font-medium rounded-md"
          >
            <!--  back button and title  -->
            <div class="flex items-center justify-between mb-8">
              <!-- Back button on the left -->
              <div class="z-10">
                <button
                  onclick="prevStep()"
                  class="back-btn"
                  type="button"
                >
                  Back
                </button>
              </div>
            </div>
            <h2 class="section_heading">Payment</h2>
            
            <!-- Payment Amount Display Text -->
            <p id="paymentAmountText" class="payment-info-text"></p>
            
            <p>
              <span style="font-weight: bold">Bkash: +8801734973058</span>
            </p>
            <div class="my-8">
              <label class="block font-semibold mb-1">
                Select Payment Method:<span class="text-red-700 ml-1">*</span>
              </label>
              <label>
                <input
                  type="radio"
                  name="payment_method"
                  value="Bkash"
                  required
                  checked
                />
                Bkash (Send Money)
              </label>
            </div>

            <div class="mb-5">
              <label for="transaction_id" class="block font-semibold mb-1">
                Transaction ID<span class="text-red-700 ml-1">*</span>
              </label>
              <input
                type="text"
                name="transaction_id"
                id="transaction_id"
                placeholder="Enter your Transaction ID"
                class="input"
                required
              />
            </div>

            <div class="mb-5">
              <label for="comments" class="block font-semibold mb-1">
                Any Comments?
              </label>
              <input
                type="text"
                name="comments"
                id="comments"
                placeholder="Share your thoughts"
                class="input"
              />
            </div>

            <div class="flex justify-center">
              <button
                type="submit"
                class="text-white px-5 py-2 border  border-[#00629B] bg-[#00629B] rounded-md hover:bg-[#d3e4f7] hover:text-[#00629B] duration-300 ease-in-out transition-all cursor-pointer"
              >
                Submit 
              </button>
            </div>
          </section>

        </form>
        {% endif %}
      </div>
    </div>

    {% if is_staff_view %}
    <div
      id="publishModal"
      class="fixed inset-0 hidden bg-black/20 backdrop-blur-sm flex items-center justify-center z-50"
    >
      <div class="bg-white rounded-xl shadow-lg w-96 p-6 text-center">
        <h2 class="text-xl font-semibold mb-4">Confirm Publish</h2>
        <p class="text-gray-600 mb-6">
          Are you sure you want to publish this form? Once published, it will be
          available for users to fill.
        </p>
        <div class="flex justify-center gap-4">
          <button
            id="cancelPublish"
            class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400"
          >
            Cancel
          </button>
          <button
            id="confirmPublish"
            class="px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700"
          >
            Yes, Publish
          </button>
        </div>
      </div>
    </div>

    <!-- Unpublish Confirmation Modal -->
    <div
      id="unpublishModal"
      class="fixed inset-0 hidden bg-black/20 backdrop-blur-sm flex items-center justify-center z-50"
    >
      <div class="bg-white rounded-xl shadow-lg w-96 p-6 text-center">
        <h2 class="text-xl font-semibold mb-4">Confirm Unpublish</h2>
        <p class="text-gray-600 mb-6">
          Are you sure you want to unpublish this form? Users will no longer be
          able to fill it.
        </p>
        <div class="flex justify-center gap-4">
          <button
            id="cancelUnpublish"
            class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400"
          >
            Cancel
          </button>
          <button
            id="confirmUnpublish"
            class="px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700"
          >
            Yes, Unpublish
          </button>
        </div>
      </div>
    </div>
    {% endif %}

    <div class="flex justify-center items-center mt-3 h-15 mx-5 text-center sticky top-140 ">
      <p class="text-white font-semibold italic">
        <small>2025 Â© All rights reserved by IEEE NSU Student Branch</small>
      </p>
    </div>

    <!-- membership grade condition  -->
    <script>
      const radios = document.querySelectorAll('input[name="membership_grade"]');
      const studentSection = document.getElementById("student_section");
      const professionalSection = document.getElementById("professional_section");
      const studentIdInput = document.getElementById("student_membership_id");
      const professionalIdInput = document.getElementById("professional_membership_id");

      radios.forEach((radio) => {
        radio.addEventListener("change", () => {
          studentSection.classList.add("hidden");
          professionalSection.classList.add("hidden");
          
          // Remove required from all membership ID fields first
          studentIdInput.removeAttribute("required");
          professionalIdInput.removeAttribute("required");

          if (radio.value === "student") {
            studentSection.classList.remove("hidden");
            studentIdInput.setAttribute("required", "required");
          } else if (radio.value === "professional") {
            professionalSection.classList.remove("hidden");
            professionalIdInput.setAttribute("required", "required");
          }
        });
      });

      // Update payment display based on membership selection
      function updatePaymentDisplay() {
        const selectedMembership = document.querySelector('input[name="membership_grade"]:checked');
        const paymentAmountText = document.getElementById('paymentAmountText');
        
        if (selectedMembership) {
          const membershipValue = selectedMembership.value;
          
          if (membershipValue === 'student') {
            paymentAmountText.innerHTML = 'For IEEE Student Member â€” You have to pay <strong>710 BDT</strong>';
          } else if (membershipValue === 'professional') {
            paymentAmountText.innerHTML = 'For IEEE Member â€” You have to pay <strong>810 BDT</strong>';
          } else if (membershipValue === 'non_ieee') {
            paymentAmountText.innerHTML = 'For Non-IEEE Members â€” You have to pay <strong>860 BDT</strong>';
          }
        }
      }

      // --- Simple 2-Page Navigation ---
      function nextStep() {
        if (!validateStep(1)) {
          Swal.fire({
            icon: 'warning',
            title: 'Incomplete Form',
            text: 'Please fill in all the required fields!'
          });
          return;
        }
        updatePaymentDisplay(); // Update payment amount when moving to step 2
        goToStep(2);
      }

      function prevStep() {
        goToStep(1);
      }

      function goToStep(stepNumber) {
        document.querySelectorAll("section[id^='step']").forEach(sec => sec.classList.add("hidden"));
        const nextSection = document.getElementById(`step${stepNumber}`);
        if (nextSection) nextSection.classList.remove("hidden");
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      function validateStep(stepNumber) {
        const currentStep = document.getElementById(`step${stepNumber}`);
        if (!currentStep) return true;
        const requiredFields = currentStep.querySelectorAll("[required]");
        
        let isValid = true;

        requiredFields.forEach(field => {
          // Skip hidden fields
          const parentSection = field.closest('.hidden');
          if (parentSection) return;

          if (field.type === 'radio') {
            const radioGroup = currentStep.querySelectorAll(`[name="${field.name}"]`);
            const isChecked = Array.from(radioGroup).some(radio => (radio.checked && !radio.disabled));

            if (!isChecked) {
              isValid = false;
              radioGroup.forEach(radio => {
                const wrapper = radio.closest('label') || radio;
                wrapper.style.color = "#b02424ff";
              });
            } else {
              radioGroup.forEach(radio => {
                const wrapper = radio.closest('label') || radio;
                wrapper.style.color = "";
              });
            }
          } else if (!field.value.trim()) {
            isValid = false;
            field.style.border = "1px solid #f13131";
          } else {
            field.style.border = "";
          }
        });
        
        return isValid;
      }

      // --- Form Submission ---
      document.getElementById('registrationForm').addEventListener('submit', function (e) {
        e.preventDefault();

        const submitBtn = document.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'Submitting...';
        submitBtn.disabled = true;

        const formData = new FormData(this);
        fetch(this.action, {
          method: 'POST',
          body: formData,
          headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value || '' }
        })
          .then(r => r.json())
          .then(data => {
            if (data.success) {
              Swal.fire({
                title: "Registration Complete ðŸŽŠ",
                text: "Thanks for signing up! Check your confirmation email (Inbox/Spam).",
                icon: "success"
              });
              this.reset();
              goToStep(1);
            } else {
              Swal.fire("Registration failed!", data.message, "error");
            }
          })
          .catch(err => Swal.fire("Error", err.message, "error"))
          .finally(() => {
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
          });
      });

      {% if is_staff_view %}
      // Get elements
      const publishToggle = document.getElementById('publishCheckbox');
      const publishText = document.getElementById('publishText');
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

      if (publishToggle) {
        publishToggle.addEventListener('change', () => {
          if (publishToggle.checked) {
            document.getElementById('publishModal').classList.remove('hidden');
          } else {
            document.getElementById('unpublishModal').classList.remove('hidden');
          }
        });

        // --- Publish Modal ---
        document.getElementById('cancelPublish').addEventListener('click', () => {
          document.getElementById('publishModal').classList.add('hidden');
          publishToggle.checked = false;
        });

        document.getElementById('confirmPublish').addEventListener('click', () => {
          document.getElementById('publishModal').classList.add('hidden');
          fetch('{% url "registration:toggle_publish" %}', {
            method: 'POST',
            headers: {
              'X-CSRFToken': csrfToken
            }
          })
          .then(r => r.json())
          .then(data => {
            publishText.textContent = data.is_published ? 'Form published!' : 'Publish Form?';
            publishText.style.color = data.is_published ? '#009b1f' : '#cf1912';
          })
          .catch(err => alert('Failed to toggle publish: ' + err.message));
        });

        // --- Unpublish Modal ---
        document.getElementById('cancelUnpublish').addEventListener('click', () => {
          document.getElementById('unpublishModal').classList.add('hidden');
          publishToggle.checked = true;
        });

        document.getElementById('confirmUnpublish').addEventListener('click', () => {
          document.getElementById('unpublishModal').classList.add('hidden');
          fetch('{% url "registration:toggle_publish" %}', {
            method: 'POST',
            headers: {
              'X-CSRFToken': csrfToken
            }
          })
          .then(r => r.json())
          .then(data => {
            publishText.textContent = data.is_published ? 'Form published!' : 'Publish Form?';
            publishText.style.color = data.is_published ? '#009b1f' : '#cf1912';
          })
          .catch(err => alert('Failed to toggle publish: ' + err.message));
        });
      }
      {% endif %}
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        particlesJS("particles-js", {
          particles: {
            number: { value: 80, density: { enable: true, value_area: 800 } },
            color: { value: "#ffffff" },
            shape: {
              type: "circle",
              stroke: { width: 0, color: "#000000" },
              polygon: { nb_sides: 5 },
              image: { src: "img/github.svg", width: 100, height: 100 },
            },
            opacity: {
              value: 1,
              random: true,
              anim: { enable: true, speed: 1, opacity_min: 0, sync: false },
            },
            size: {
              value: 3,
              random: true,
              anim: { enable: false, speed: 4, size_min: 0.3, sync: false },
            },
            line_linked: {
              enable: true,
              distance: 150,
              color: "#ffffff",
              opacity: 0.4,
              width: 1,
            },
            move: {
              enable: true,
              speed: 1,
              direction: "none",
              random: true,
              straight: false,
              out_mode: "out",
              bounce: false,
              attract: { enable: false, rotateX: 600, rotateY: 600 },
            },
          },
          interactivity: {
            detect_on: "canvas",
            events: {
              onhover: { enable: false, mode: "bubble" },
              onclick: { enable: false, mode: "repulse" },
              resize: true,
            },
            modes: {
              grab: { distance: 400, line_linked: { opacity: 1 } },
              bubble: {
                distance: 250,
                size: 0,
                duration: 2,
                opacity: 0,
                speed: 3,
              },
              repulse: { distance: 400, duration: 0.4 },
              push: { particles_nb: 4 },
              remove: { particles_nb: 2 },
            },
          },
          retina_detect: true,
        });
        var count_particles, stats, update;
        stats = new Stats();
        stats.setMode(0);
        stats.domElement.style.position = "absolute";
        stats.domElement.style.left = "0px";
        stats.domElement.style.top = "0px";
        document.body.appendChild(stats.domElement);
        count_particles = document.querySelector(".js-count-particles");
        update = function () {
          stats.begin();
          stats.end();
          if (
            window.pJSDom[0].pJS.particles &&
            window.pJSDom[0].pJS.particles.array
          ) {
            count_particles.innerText =
              window.pJSDom[0].pJS.particles.array.length;
          }
          requestAnimationFrame(update);
        };
        requestAnimationFrame(update);
      });
    </script>
  </body>
</html>